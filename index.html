<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Train Tracker (Speed-Based ETA)</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light text-dark">
<div class="container my-4">
  <h1 class="mb-3">Train Tracker with Speed-Based ETA</h1>

  <!-- Display current data -->
  <div class="mb-3">
    <p><strong>Current Station:</strong> <span id="currentStation">N/A</span></p>
    <p><strong>Direction:</strong> <span id="direction">N/A</span></p>
    <p><strong>State:</strong> <span id="trainState">N/A</span></p>
    <p><strong>Last Update:</strong> <span id="lastUpdate">N/A</span></p>
    <p><strong>Speed (km/h):</strong> <span id="speed">N/A</span></p>
  </div>

  <hr/>

  <!-- User picks origin/destination -->
  <div class="row mb-3">
    <div class="col">
      <label for="originSelect" class="form-label">Origin Station</label>
      <select id="originSelect" class="form-select">
        <option value="1">Station 1</option>
        <option value="2" selected>Station 2</option>
        <option value="3">Station 3</option>
      </select>
    </div>
    <div class="col">
      <label for="destSelect" class="form-label">Destination Station</label>
      <select id="destSelect" class="form-select">
        <option value="1">Station 1</option>
        <option value="2">Station 2</option>
        <option value="3" selected>Station 3</option>
      </select>
    </div>
  </div>

  <div class="alert alert-info">
    <strong>Estimated Time of Arrival:</strong>
    <span id="eta">N/A</span>
  </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
/*
  This version calculates ETA based on:
    - Summing the distances (in kilometers) for each route segment
    - Dividing by the trainâ€™s current speed (km/h) from /currentStatus
    - Subtracting the time elapsed since last update

  If the train is MANEUVERING_1 or MANEUVERING_3, it displays "Train is maneuvering. ETA unavailable."
*/

const distances = {
  "1->2": 1.0,
  "2->1": 1.0,
  "2->3": 1.0,
  "3->2": 1.0
};

const DEFAULT_SPEED_KMH = 20.0;

// Poll status every second
setInterval(fetchTrainStatus, 1000);

function fetchTrainStatus() {
  $.getJSON("/currentStatus", function(data) {
    // Update displayed info
    $("#currentStation").text(data.current_station ?? "N/A");
    $("#direction").text(data.direction ?? "N/A");
    $("#trainState").text(data.state ?? "N/A");
    $("#lastUpdate").text(data.last_update_time ?? "N/A");

    if (data.speed_km_h != null) {
      $("#speed").text(data.speed_km_h.toFixed(2));
    } else {
      $("#speed").text("N/A");
    }

    // Compute ETA
    const etaStr = calculateETA(data);
    $("#eta").text(etaStr);
  });
}

function calculateETA(trainData) {
  const state = trainData.state;
  if (state === "MANEUVERING_1" || state === "MANEUVERING_3") {
    return "Train is maneuvering. ETA unavailable.";
  }

  const origin = $("#originSelect").val();
  const destination = $("#destSelect").val();
  if (!origin || !destination) return "Select origin & destination.";
  if (origin === destination) return "Origin = Destination";

  const cStation = trainData.current_station;
  let speed = trainData.speed_km_h;
  if (!speed || speed <= 0) speed = DEFAULT_SPEED_KMH;

  const lastUpdateStr = trainData.last_update_time;
  if (!cStation || !lastUpdateStr) return "No current station data";

  const lastUpdate = new Date(lastUpdateStr);
  const now = new Date();
  let elapsedMin = (now - lastUpdate) / (1000 * 60);
  if (elapsedMin < 0) elapsedMin = 0;

  // We'll assume route: current->origin + origin->destination
  const distToOrigin = computeRouteDistance(cStation, origin);
  const distOriginToDest = computeRouteDistance(origin, destination);
  const totalDistance = distToOrigin + distOriginToDest;

  // time in hours = distance / speed
  let totalTimeMin = (totalDistance / speed) * 60;
  let remaining = totalTimeMin - elapsedMin;
  if (remaining < 0) remaining = 0;

  if (remaining <= 1) return "Arrived!";

  const hrs = Math.floor(remaining / 60);
  const mins = Math.floor(remaining % 60);
  const secs = Math.floor((remaining - hrs * 60 - mins) * 60);

  return `${hrs} hr ${mins} min ${secs} sec`;
}

function computeRouteDistance(stA, stB) {
  if (+stA === +stB) return 0;
  const path = getPathBetweenStations(+stA, +stB);
  let distanceSum = 0;
  for (let i=0; i<path.length-1; i++) {
    const s1 = path[i], s2 = path[i+1];
    const key = `${s1}->${s2}`;
    if (distances[key] != null) {
      distanceSum += distances[key];
    }
  }
  return distanceSum;
}

// For a simple 1->2->3 route, build forward [1,2,3] or backward [3,2,1]
function getPathBetweenStations(a,b) {
  let route = [];
  if (a < b) {
    for (let s=a; s<=b; s++) route.push(s);
  } else {
    for (let s=a; s>=b; s--) route.push(s);
  }
  return route;
}
</script>
</body>
</html>
